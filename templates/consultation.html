<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Consultation Session</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @keyframes pulse-ring { 0% { transform: scale(0.8); opacity: 0.5; } 100% { transform: scale(1.3); opacity: 0; } }
        .recording-pulse { animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite; }
        /* Countdown Overlay */
        #countdown-overlay { display: none; background: rgba(0,0,0,0.8); position: fixed; inset: 0; z-index: 50; justify-content: center; align-items: center; color: white; font-size: 8rem; font-weight: bold; }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col font-sans">

    <div id="countdown-overlay">3</div>

    <header class="bg-white border-b border-gray-200 px-8 py-4 flex justify-between items-center shadow-sm">
        <div class="flex items-center gap-4">
            <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold">Dr</div>
            <div>
                <h1 class="font-bold text-gray-800">Consultation Session</h1>
                <p class="text-xs text-gray-500">Dr. {{ doctor_name }}</p>
            </div>
        </div>
        <div class="bg-blue-50 px-4 py-2 rounded-lg border border-blue-100">
            <span class="text-xs font-bold text-blue-500 uppercase">Patient</span>
            <div class="font-bold text-gray-800">{{ patient.name }} <span class="text-gray-400 font-normal">| {{ patient.age }} y/o</span></div>
        </div>
    </header>

    <main class="flex-1 p-6 overflow-hidden flex gap-6">
        
        <div class="w-1/3 flex flex-col gap-6">
            <div class="bg-gray-900 rounded-2xl p-6 shadow-lg flex flex-col items-center justify-center relative overflow-hidden flex-1">
                <canvas id="visualizer" class="w-full h-32 mb-4"></canvas>
                <div id="recording-status" class="text-gray-400 text-sm font-mono mb-4">Ready to Record</div>
                
                <button id="record-btn" onclick="startCountdown()" class="w-20 h-20 bg-red-500 hover:bg-red-600 rounded-full flex items-center justify-center text-white shadow-xl transition transform hover:scale-105">
                    <i class="fas fa-microphone text-3xl"></i>
                </button>
                <button id="stop-btn" onclick="stopRecording()" class="hidden w-20 h-20 bg-gray-700 hover:bg-gray-600 rounded-full flex items-center justify-center text-white shadow-xl transition border-4 border-red-500">
                    <i class="fas fa-stop text-3xl"></i>
                </button>
            </div>

            <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-200 flex-1 flex flex-col">
                <h3 class="text-xs font-bold text-gray-400 uppercase mb-2"><i class="fas fa-stream mr-1"></i> Real-time Raw Transcription</h3>
                <textarea id="raw-text" readonly class="w-full flex-1 bg-gray-50 border border-gray-100 rounded-lg p-3 text-sm text-gray-700 outline-none resize-none font-mono" placeholder="Speech text will appear here as you talk..."></textarea>
            </div>
        </div>

        <div class="w-2/3 bg-white rounded-2xl shadow-sm border border-gray-200 flex flex-col relative">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50 rounded-t-2xl">
                <h2 class="font-bold text-gray-700 flex items-center gap-2"><i class="fas fa-notes-medical text-blue-500"></i> Medical Note (SOAP)</h2>
                <div id="processing-indicator" class="hidden flex items-center gap-2 text-blue-600 text-sm font-bold">
                    <i class="fas fa-spinner fa-spin"></i> Processing AI...
                </div>
            </div>
            
            <textarea id="soap-note" class="flex-1 p-6 outline-none text-gray-800 text-base leading-relaxed resize-none font-sans" placeholder="S: ...&#10;O: ...&#10;A: ...&#10;P: ..."></textarea>
            
            <div class="p-4 border-t border-gray-100 flex justify-end gap-3 bg-gray-50 rounded-b-2xl">
                <button onclick="saveNote('draft')" class="px-6 py-2 text-gray-600 hover:bg-gray-200 rounded-lg font-bold transition">Save Draft</button>
                <button onclick="saveNote('finalize')" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold shadow-md transition">
                    Finalize & Sign <i class="fas fa-file-signature ml-2"></i>
                </button>
            </div>
        </div>

    </main>

    <script>
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        let recognition; // For Real-time Text

        // --- 1. COUNTDOWN LOGIC ---
        function startCountdown() {
            const overlay = document.getElementById('countdown-overlay');
            overlay.style.display = 'flex';
            let count = 3;
            overlay.innerText = count;

            const timer = setInterval(() => {
                count--;
                if(count > 0) {
                    overlay.innerText = count;
                } else {
                    clearInterval(timer);
                    overlay.style.display = 'none';
                    startRecording(); // Actually start
                }
            }, 1000);
        }

        // --- 2. AUDIO & VISUALIZER LOGIC ---
        async function startRecording() {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];

            // Setup Visualizer (Waveform Style)
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const source = audioCtx.createMediaStreamSource(stream);
            const analyser = audioCtx.createAnalyser();
            analyser.fftSize = 2048; 
            source.connect(analyser);
            drawWaveform(analyser);

            // Setup Real-time Text
            startRealTimeText();

            mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
            mediaRecorder.start();

            isRecording = true;
            document.getElementById('record-btn').classList.add('hidden');
            document.getElementById('stop-btn').classList.remove('hidden');
            document.getElementById('recording-status').innerText = "Recording in Progress...";
            document.getElementById('recording-status').classList.add('text-red-500', 'animate-pulse');
        }

        function stopRecording() {
            mediaRecorder.stop();
            isRecording = false;
            if(recognition) recognition.stop(); // Stop text
            
            document.getElementById('record-btn').classList.remove('hidden');
            document.getElementById('stop-btn').classList.add('hidden');
            document.getElementById('recording-status').innerText = "Processing Audio...";
            document.getElementById('recording-status').classList.remove('text-red-500', 'animate-pulse');
            document.getElementById('processing-indicator').classList.remove('hidden');

            mediaRecorder.onstop = () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                const formData = new FormData();
                formData.append("audio_data", audioBlob);
                formData.append("visit_id", "{{ visit.id }}");

                fetch('/process_audio', { method: 'POST', body: formData })
                .then(r => r.json())
                .then(data => {
                    document.getElementById('soap-note').value = data.soap_note;
                    document.getElementById('processing-indicator').classList.add('hidden');
                    document.getElementById('recording-status').innerText = "Ready to Record";
                });
            };
        }

        // --- 3. WAVEFORM VISUALIZER ---
        function drawWaveform(analyser) {
            const canvas = document.getElementById("visualizer");
            const ctx = canvas.getContext("2d");
            const bufferLength = analyser.fftSize;
            const dataArray = new Uint8Array(bufferLength);

            function draw() {
                if(!isRecording) return;
                requestAnimationFrame(draw);
                analyser.getByteTimeDomainData(dataArray);

                ctx.fillStyle = "rgb(17, 24, 39)"; // Match bg-gray-900
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.lineWidth = 2;
                ctx.strokeStyle = "rgb(59, 130, 246)"; // Blue line
                ctx.beginPath();

                const sliceWidth = canvas.width * 1.0 / bufferLength;
                let x = 0;

                for(let i = 0; i < bufferLength; i++) {
                    const v = dataArray[i] / 128.0;
                    const y = v * canvas.height / 2;
                    if(i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                    x += sliceWidth;
                }
                ctx.lineTo(canvas.width, canvas.height / 2);
                ctx.stroke();
            }
            draw();
        }

        // --- 4. REAL-TIME TEXT (Web Speech API) ---
        function startRealTimeText() {
            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = true;
                
                recognition.onresult = function(event) {
                    let final = '';
                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) {
                            final += event.results[i][0].transcript;
                        } else {
                            // Interim
                            document.getElementById('raw-text').value = final + event.results[i][0].transcript;
                        }
                    }
                    if(final) document.getElementById('raw-text').value += final + ' ';
                };
                recognition.start();
            } else {
                document.getElementById('raw-text').value = "Browser doesn't support Real-time API.";
            }
        }

        // --- 5. FINALIZE & REDIRECT ---
        function saveNote(action) {
            const note = document.getElementById('soap-note').value;
            fetch('/save_consultation', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ visit_id: "{{ visit.id }}", note: note, action: action })
            })
            .then(r => r.json())
            .then(data => {
                if(data.status === 'success') {
                    if(action === 'finalize') {
                        alert("Consultation Finalized & Saved!");
                        window.location.href = "/doctor/dashboard"; // Redirect to Dashboard
                    } else {
                        alert("Draft Saved.");
                    }
                }
            });
        }
    </script>
</body>
</html>